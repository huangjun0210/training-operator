plank:
  # TODO(jlewi): This URL would need to be changed if we end up using our own dashboard.
  job_url_template: 'https://k8s-gubernator.appspot.com/build/kubernetes-jenkins/{{if eq .Spec.Type "presubmit"}}pr-logs/pull{{else if eq .Spec.Type "batch"}}pr-logs/pull{{else}}logs{{end}}{{if ne .Spec.Refs.Org ""}}{{if ne .Spec.Refs.Org "kubernetes"}}/{{.Spec.Refs.Org}}_{{.Spec.Refs.Repo}}{{else if ne .Spec.Refs.Repo "kubernetes"}}/{{.Spec.Refs.Repo}}{{end}}{{end}}{{if eq .Spec.Type "presubmit"}}/{{with index .Spec.Refs.Pulls 0}}{{.Number}}{{end}}{{else if eq .Spec.Type "batch"}}/batch{{end}}/{{.Spec.Job}}/{{.Status.BuildID}}/'
  report_template: '[Full PR test history](https://k8s-gubernator.appspot.com/pr/{{if eq .Spec.Refs.Org "kubernetes"}}{{if eq .Spec.Refs.Repo "kubernetes"}}{{else}}{{.Spec.Refs.Repo}}/{{end}}{{else}}{{.Spec.Refs.Org}}_{{.Spec.Refs.Repo}}/{{end}}{{with index .Spec.Refs.Pulls 0}}{{.Number}}{{end}}). [Your PR dashboard](https://k8s-gubernator.appspot.com/pr/{{with index .Spec.Refs.Pulls 0}}{{.Author}}{{end}}). Please help us cut down on flakes by [linking to](https://github.com/kubernetes/community/blob/master/contributors/devel/flaky-tests.md#filing-issues-for-flaky-tests) an [open issue](https://github.com/{{.Spec.Refs.Org}}/{{.Spec.Refs.Repo}}/issues?q=is:issue+is:open) when you hit one in your PR.'

sinker:
  resync_period: 1h
  max_prowjob_age: 48h
  max_pod_age: 1h

prowjob_namespace: default
pod_namespace: test-pods
log_level: info

tide:
  queries:
  - "type:pr state:open repo:kubernetes/test-infra label:lgtm label:approved -label:needs-ok-to-test -label:do-not-merge/work-in-progress -label:do-not-merge/hold label:\"cncf-cla: yes\""

push_gateway:
  endpoint: pushgateway

presubmits:
  jlewi/mlkube.io:
  - name: mlkube-build-presubmit
    agent: kubernetes
    always_run: true         # Run for every PR, or only when requested.
    rerun_command: "/test mlkube-build"
    trigger: "(?m)^/test( all| mlkube-build),?(\\s+|$)"
    branches:
    - master
    spec:
      containers:
      # TODO(jlewi): Replace latest with a specific tag once the images stabilize.
      - image: gcr.io/mlkube-testing/builder:latest
        env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /etc/service-account/service-account.json
        # We need privileged mode to run Docker.
        securityContext:
          privileged: true
        volumeMounts:
        - name: service
          mountPath: /etc/service-account
          readOnly: true
        - name: docker
          mountPath: /var/run/docker.sock
      volumes:
      - name: service
        secret:
          secretName: service-account
      - name: docker
        hostPath:
          path: /var/run/docker.sock

postsubmits:
  jlewi/mlkube.io:
  - name: mlkube-build-postsubmit
    agent: kubernetes
    branches:
    - master
    spec:
      containers:
      # TODO(jlewi): Replace latest with a specific tag once the images stabilize.
      - image: gcr.io/mlkube-testing/builder:latest
        env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /etc/service-account/service-account.json
        # We need privileged mode to run Docker.
        securityContext:
          privileged: true
        volumeMounts:
        - name: service
          mountPath: /etc/service-account
          readOnly: true
        - name: docker
          mountPath: /var/run/docker.sock
      volumes:
      - name: service
        secret:
          secretName: service-account
      - name: docker
        hostPath:
          path: /var/run/docker.sock
